<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Reddit r/india sub-reddit Data Analysis Part 1 - Hari Govardhanam</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" />
    <!--<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" rel="stylesheet" />-->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/theme/style.css" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="">Hari Govardhanam</a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="https://github.com/harigov"><i class="fa fa-github-square fa-lg"></i></a></li>
            <li><a href="https://linkedin.com/in/harigov"><i class="fa fa-linkedin fa-lg"></i></a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
    <section id="content" class="article content">
      <header>
        <h2 class="entry-title">
          Reddit r/india sub-reddit Data Analysis Part 1
        </h2>
        
        <div class="text-muted">Sat 14 October 2017</div>
      </header>
<!-- .entry-content -->
      <div class="entry-content">
        <p>This is a simple data exploration of /r/india subreddit to identify access patterns, just for fun. As this is a jupyter notebook, you will see code interspersed with images and comments. This is intentional. It gives you an idea on how this data is processed and extracted so you can be sure of the data. It is also instructional, if you are interested in data exploration like this. If you are not a coder, simply skip those code sections. :)</p>
<p>If you are not interested in knowing how this data analysis is done, feel free to skip this section and head straight to pretty graphs.</p>
<h2>Data Extraction Process</h2>
<p>The data set contains data from 09/2016 to 09/2017 so an years worth of data downloaded from reddit public dataset on Google BigQuery at https://bigquery.cloud.google.com. I ran the following query to download submissions:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> 
    <span class="n">id</span><span class="p">,</span> <span class="n">created_utc</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">num_comments</span><span class="p">,</span> 
    <span class="n">score</span><span class="p">,</span> <span class="n">ups</span><span class="p">,</span> <span class="n">downs</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">selftext</span><span class="p">,</span> <span class="n">link_flair_text</span> 
<span class="k">FROM</span> 
    <span class="o">`</span><span class="n">fh</span><span class="o">-</span><span class="n">bigquery</span><span class="p">.</span><span class="n">reddit_posts</span><span class="p">.</span><span class="mi">201</span><span class="o">*`</span> 
<span class="k">WHERE</span> 
    <span class="n">subreddit</span><span class="o">=</span><span class="ss">&quot;india&quot;</span> <span class="k">and</span> <span class="n">_TABLE_SUFFIX</span> <span class="k">BETWEEN</span> <span class="s1">&#39;6_09&#39;</span> <span class="k">and</span> <span class="s1">&#39;7_09&#39;</span> <span class="k">and</span> 
    <span class="n">num_comments</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">and</span> <span class="n">selftext</span> <span class="o">!=</span> <span class="s1">&#39;[deleted]&#39;</span> <span class="k">and</span> 
    <span class="n">selftext</span> <span class="o">!=</span><span class="s1">&#39;[removed]&#39;</span><span class="k">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">2</span>
</pre></div>


<p>And the following query to download comments:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> 
    <span class="n">id</span><span class="p">,</span> <span class="n">created_utc</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ups</span><span class="p">,</span> <span class="n">downs</span><span class="p">,</span> <span class="n">parent_id</span> 
<span class="k">FROM</span> 
    <span class="o">`</span><span class="n">fh</span><span class="o">-</span><span class="n">bigquery</span><span class="p">.</span><span class="n">reddit_comments</span><span class="p">.</span><span class="mi">201</span><span class="o">*`</span>
<span class="k">WHERE</span>
    <span class="n">subreddit</span><span class="o">=</span><span class="ss">&quot;india&quot;</span> <span class="k">and</span> <span class="n">_TABLE_SUFFIX</span> <span class="k">BETWEEN</span> <span class="s1">&#39;6_09&#39;</span> <span class="k">and</span> <span class="s1">&#39;7_09&#39;</span> <span class="k">and</span> 
    <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>


<p>As you can see I did some filtering on data to reduce the data size so I maybe downstating some numbers in this analysis. I had to export this data to a custom table and then export to a Google Cloud Storage bucket. It is relatively straightforward to download data from Google Cloud Storage once you export data over there. This approach is very fast compared to using praw for querying reddit, as you get a bulk of data without making thousands of queries. Unfortunately, this public dataset hosted on BigQuery didn't have user data like when a user joined, their karma and score. This required me to make bulk queries using praw anyway. I will have that code added at the bottom of this post, if you are interested.</p>
<p>When exporting data from BigQuery, I used "avro" export format as it holds schema information, which makes it easy to parse the data in python. Alternatively, one can use csv or json format. If you choose to use either of those, please keep in mind that submission title and comments may contain a comma or other punctuation marks that might affect parsing.</p>
<h2>Local Database Schema</h2>
<p>Once I downloaded the data, I loaded it into a local sqlite database. Overall the data size isn't large enough to necessitate heavyweight databases and any performance reasons aren't an issue because I have a powerful computer to load and process. In sqlite database, I created three tables called submissions, comments and users. No awards for guessing what they hold. Here is the exact SQL queries that I used to create those tables</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> 
    <span class="p">(</span><span class="n">user_id</span> <span class="nb">text</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">user_since</span> <span class="k">timestamp</span><span class="p">,</span> 
    <span class="n">link_karma</span> <span class="nb">real</span><span class="p">,</span> <span class="n">comment_karma</span> <span class="nb">real</span><span class="p">)</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">submissions</span> 
    <span class="p">(</span><span class="n">submission_id</span> <span class="nb">text</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">title</span> <span class="nb">text</span><span class="p">,</span> <span class="n">content</span> <span class="nb">text</span><span class="p">,</span> 
    <span class="n">link_flair_text</span> <span class="nb">text</span><span class="p">,</span> <span class="n">posted_at</span> <span class="k">timestamp</span><span class="p">,</span> <span class="n">posted_by</span> <span class="nb">text</span><span class="p">,</span> 
    <span class="n">upvotes</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downvotes</span> <span class="nb">int</span><span class="p">,</span> <span class="n">score</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_comments</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">comments</span> 
    <span class="p">(</span><span class="n">comment_id</span> <span class="nb">text</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">submission_id</span> <span class="nb">text</span><span class="p">,</span> <span class="n">parent_comment_id</span> <span class="nb">text</span><span class="p">,</span> 
    <span class="n">content</span> <span class="nb">text</span><span class="p">,</span> <span class="n">posted_at</span> <span class="k">timestamp</span><span class="p">,</span> <span class="n">posted_by</span> <span class="nb">text</span><span class="p">,</span> <span class="n">upvotes</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">downvotes</span> <span class="nb">int</span><span class="p">,</span> <span class="n">score</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>


<p>Unfortunately BigQuery public dataset for comments doesn't contain any submission identifier for comment other than parent_id. So this requires some preprocessing to identify the submission id.</p>
<p>I gathered details of all the users who posted atleast one submission or comment during the timeperiod by making queries to reddit api and stored that details in users table.</p>
<p>In the below sections, you will see a lot of data is extracted by making SQL queries to above tables. Majority of the data can be extracted by simple queries. I will have a separate post that does more post-processing on this data but for now, this should be a good start.</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">tabulate</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s1">&#39;retina&#39;</span>

<span class="n">conn</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;reddit.db&#39;</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> 
              <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">imwidth</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">imheight</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">imwidth</span><span class="p">,</span> <span class="n">imheight</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</pre></div>


<h2>Distribution of User Activity By Month</h2>
<p>This subreddit started seeing a lot more activity these days so I wanted to see how dramatic is the increase over last year. It turns out that we had a massive spike around November 2016 that persisted for the most part. I thought the spike may have been because of demonetization but I don't know if it is because of new users or existing users participating more so I tried to look at new users joined during the period of Sept-Dec 2016. I included before and after time to see if a lot more people joined during the time. It turns out that wasn't the case. We didn't have a spike of new users. It's just existing users participating more.</p>
<div class="highlight"><pre><span></span><span class="c1"># Monthly stats</span>
<span class="n">submissions_monthly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(posted_at, &#39;start of month&#39;) as month, count(*) from submissions group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">comments_monthly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(posted_at, &#39;start of month&#39;) as month, count(*) from comments group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">users_monthly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(user_since, &#39;start of month&#39;) as month, count(*) from users group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">new_users_sept_dec</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;select date(user_since, &#39;weekday 1&#39;) as day, count(*) as count </span>
<span class="sd">     from users where day&gt;&#39;2016-09-01&#39; and day&lt;=&#39;2016-12-31&#39; group by day&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_monthly</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_monthly</span><span class="p">],</span>
          <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Submissions&#39;</span><span class="p">,</span> <span class="s1">&#39;Submissions Per Month&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_monthly</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_monthly</span><span class="p">],</span>
          <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments Per Month&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_monthly</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_monthly</span><span class="p">],</span>
          <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="s1">&#39;Users Joined Per Month&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">new_users_sept_dec</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">new_users_sept_dec</span><span class="p">],</span>
          <span class="s1">&#39;Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="s1">&#39;Users Joined Per Day Before And After Demonetization&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">imwidth</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>


<p><img src="/images/reddit_da/submissions_per_month.png" width="80%">
<img src="/images/reddit_da/comments_per_month.png" width="80%">
<img src="/images/reddit_da/users_joined_per_month.png" width="80%">
<img src="/images/reddit_da/users_joined_per_day_demonetization.png" width="80%"></p>
<h2>Distribution of User Activity across different days of the Week</h2>
<p>I wanted to know if we are more active during any day of the week. There is minor variation but nothing notable. It truly seems like a daily pasttime of everyone in the subreddit.</p>
<div class="highlight"><pre><span></span><span class="c1"># Weekly stats</span>
<span class="n">submissions_weekday</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select weekday, avg(count) from (select strftime(&#39;%w&#39;, posted_at) as weekday, strftime(&#39;%W&#39;, posted_at) as week, count(*) as count from submissions group by week, weekday) group by weekday&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">comments_weekday</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select weekday, avg(count) from (select strftime(&#39;%w&#39;, posted_at) as weekday, strftime(&#39;%W&#39;, posted_at) as week, count(*) as count from comments group by week, weekday) group by weekday&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">users_weekday</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select weekday, avg(count) from (select strftime(&#39;%w&#39;, user_since) as weekday, strftime(&#39;%W&#39;, user_since) as week, count(*) as count from users group by week, weekday) group by weekday&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_weekday</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_weekday</span><span class="p">],</span> 
          <span class="s1">&#39;Weekday&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Submissions&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Submissions on a Weekday&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_weekday</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_weekday</span><span class="p">],</span>
          <span class="s1">&#39;Weekday&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Comments&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Comments on a Weekday&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_weekday</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_weekday</span><span class="p">],</span> 
          <span class="s1">&#39;Weekday&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Users&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Users Joined on a Weekday&#39;</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>


<p><img src="/images/reddit_da/avg_submissions_weekday.png" width="80%">
<img src="/images/reddit_da/avg_comments_weekday.png" width="80%">
<img src="/images/reddit_da/avg_users_joined_weekday.png" width="80%"></p>
<h2>Distribution of User Activity across different times of the Day</h2>
<p>It looks like the first thing that people do after going to office is to access reddit. I guess one could use this information to gain traction when posting messages or submissions. Other than that, nothing unexpected here.</p>
<div class="highlight"><pre><span></span><span class="c1"># Hourly stats</span>
<span class="n">submissions_hourly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select (5.5+hour) as hour, avg(count) from (select strftime(&#39;%H&#39;, posted_at) as hour, date(posted_at) as date, count(*) as count from submissions group by date, hour) group by hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">comments_hourly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select (5.5+hour) as hour, avg(count) from (select strftime(&#39;%H&#39;, posted_at) as hour, date(posted_at) as date, count(*) as count from comments group by date, hour) group by hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">users_hourly</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select (5.5+hour), sum(count) from (select strftime(&#39;%H&#39;, user_since) as hour, date(user_since) as date, count(*) as count from users group by date, hour) group by hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_hourly</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">submissions_hourly</span><span class="p">],</span> 
          <span class="s1">&#39;Hours in Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Submissions&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Submissions at different times of the day&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_hourly</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">comments_hourly</span><span class="p">],</span> 
          <span class="s1">&#39;Hours in Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Comments&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Comments at different times of the day&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_hourly</span><span class="p">],</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">users_hourly</span><span class="p">],</span> 
          <span class="s1">&#39;Hours in Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Users Joined&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Users Joined at different times of the day&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>


<p><img src="/images/reddit_da/avg_submissions_time.png" width="80%">
<img src="/images/reddit_da/avg_comments_time.png" width="80%">
<img src="/images/reddit_da/avg_users_joined_time.png" width="80%"></p>
<h2>User Submission and Comment Metrics</h2>
<p>I was wondering if users who joined during a particular month are more or less likely to submit or comment. There are some spikes but I haven't had time to fully investigate.</p>
<p>In a similar vein, I was wondering if users from certain month are voted high for some reason and there are some spikes. I think this maybe because of some highly active users who joined during that time. I will investigate it later.</p>
<div class="highlight"><pre><span></span><span class="c1"># Number of submissions by authors age</span>
<span class="n">user_submissions</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(user_since, &#39;start of month&#39;) as month, avg(count) from users join (select posted_by, count(*) as count from submissions group by posted_by) on users.user_id==posted_by group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">user_comments</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(user_since, &#39;start of month&#39;) as month, avg(count) from users join (select posted_by, count(*) as count from comments group by posted_by) on users.user_id==posted_by group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_submissions</span><span class="p">],</span> 
          <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_submissions</span><span class="p">],</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;User Submissions&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Average User Submissions Based on User Joining Date&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_comments</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_comments</span><span class="p">],</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;User Comments&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Average User Comments Based on User Joining Date&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>


<p><img src="/images/reddit_da/avg_submissions_user_joining_date.png" width="80%">
<img src="/images/reddit_da/avg_user_comments_joining_date.png" width="80%"></p>
<div class="highlight"><pre><span></span><span class="c1"># Score of submissions by authors age</span>
<span class="n">user_submission_scores</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(user_since, &#39;start of month&#39;) as month, avg(score) from users join (select posted_by, sum(score) as score from submissions group by posted_by) on users.user_id==posted_by group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">user_comment_scores</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select date(user_since, &#39;start of month&#39;) as month, avg(score) from users join (select posted_by, sum(score) as score from comments group by posted_by) on users.user_id==posted_by group by month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_submission_scores</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_submission_scores</span><span class="p">],</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Score&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Average Score of Submissions Based on User Age&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plot_data</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_comment_scores</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">user_comment_scores</span><span class="p">],</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Score&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Average Score of Comments Based on User Age&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>


<p><img src="/images/reddit_da/avg_submission_score_user_age.png" width="80%">
<img src="/images/reddit_da/avg_comments_score_user_age.png" width="80%"></p>
<h2>Most Active Users</h2>
<p>These are the users who made either most submissions or most comments. Anyone who worries about AI taking away jobs has one more data point here. Instead of recruiting hundreds of people, we have bots doing quite a lot of grunt work. I am pretty sure all those humans currently recruited to post large number of messages against other political parties and companies will be next. You know who you are.</p>
<div class="highlight"><pre><span></span><span class="c1"># Most frequent submission authors</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select posted_by, count(*) as count from submissions group by posted_by order by count desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">11</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span> <span class="s1">&#39;Submissions&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Username</th>
<th>Submissions</th>
</tr>
</thead>
<tbody>
<tr>
<td>gcs8</td>
<td>643</td>
</tr>
<tr>
<td>pannagasamir</td>
<td>610</td>
</tr>
<tr>
<td>swacchreddit</td>
<td>556</td>
</tr>
<tr>
<td>aryaninvader</td>
<td>481</td>
</tr>
<tr>
<td>modiusoperandi</td>
<td>458</td>
</tr>
<tr>
<td>TemptNotTheBlade</td>
<td>454</td>
</tr>
<tr>
<td>hipporama</td>
<td>439</td>
</tr>
<tr>
<td>HornOK</td>
<td>323</td>
</tr>
<tr>
<td>ppatra</td>
<td>322</td>
</tr>
<tr>
<td>darklordind</td>
<td>316</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><span class="c1"># Most frequent comment authors</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select posted_by, count(*) as count from comments group by posted_by order by count desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">11</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span> <span class="s1">&#39;Comments&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Username</th>
<th>Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>samacharbot2</td>
<td>33221</td>
</tr>
<tr>
<td>AwkwardMod</td>
<td>26021</td>
</tr>
<tr>
<td>TemptNotTheBlade</td>
<td>11680</td>
</tr>
<tr>
<td>anti_anti_adblock</td>
<td>9350</td>
</tr>
<tr>
<td>gcs8</td>
<td>6639</td>
</tr>
<tr>
<td>bhiliyam</td>
<td>6562</td>
</tr>
<tr>
<td>donoteatthatfrog</td>
<td>5686</td>
</tr>
<tr>
<td>swacchreddit</td>
<td>5569</td>
</tr>
<tr>
<td>ppatra</td>
<td>5558</td>
</tr>
<tr>
<td>charavaka</td>
<td>5297</td>
</tr>
</tbody>
</table>
<h2>Most Popular Users</h2>
<p>These are the users who received maximum score for their submissions and comments. Looks like these highly active users need investigation.</p>
<div class="highlight"><pre><span></span><span class="c1"># Most popular (based on score) submission authors</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select posted_by, sum(score) as score from submissions group by posted_by order by score desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">11</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span> <span class="s1">&#39;Submission Score&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Username</th>
<th>Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>hipporama</td>
<td>43363</td>
</tr>
<tr>
<td>pannagasamir</td>
<td>34396</td>
</tr>
<tr>
<td>wordswithmagic</td>
<td>28209</td>
</tr>
<tr>
<td>aryaninvader</td>
<td>26022</td>
</tr>
<tr>
<td>TemptNotTheBlade</td>
<td>22450</td>
</tr>
<tr>
<td>gcs8</td>
<td>22383</td>
</tr>
<tr>
<td>ironypatrol</td>
<td>21829</td>
</tr>
<tr>
<td>modiusoperandi</td>
<td>21447</td>
</tr>
<tr>
<td>spikyraccoon</td>
<td>19153</td>
</tr>
<tr>
<td>ab0mI</td>
<td>17806</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><span class="c1"># Most popular (based on score) comment authors</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select posted_by, sum(score) as score from comments group by posted_by order by score desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">11</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span> <span class="s1">&#39;Comment Score&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Username</th>
<th>Comment Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>TemptNotTheBlade</td>
<td>61177</td>
</tr>
<tr>
<td>Not_a_kulcha</td>
<td>59741</td>
</tr>
<tr>
<td>ribiy</td>
<td>46236</td>
</tr>
<tr>
<td>samacharbot2</td>
<td>39752</td>
</tr>
<tr>
<td>swacchreddit</td>
<td>37643</td>
</tr>
<tr>
<td>AwkwardMod</td>
<td>37398</td>
</tr>
<tr>
<td>modiusoperandi</td>
<td>35069</td>
</tr>
<tr>
<td>charavaka</td>
<td>33366</td>
</tr>
<tr>
<td>bhiliyam</td>
<td>32679</td>
</tr>
<tr>
<td>GoldPisseR</td>
<td>32073</td>
</tr>
</tbody>
</table>
<h2>Submissions by Flair</h2>
<p>I think Politics takes up quite a lot of space in Indian mind and it shows in the data. ~24% of posts were tagged with Politics flair. I am actually surprised that we had more Non-Politics posts than Politics.</p>
<p>With respect to submission score, taking direct average is useless because of many custom flairs. If I filter out all the flairs with less than 10 posts, we have a much more representative sample. From that, excluding subreddit management related flairs, Politics ranks sixth highest rated flair with AMA, Sports, Reddiquette, Non-political and Entertainment taking top spots. That sounds reasonable. If submission scores were to be considered as a proxy for user interests, people are more interested in other things than Politics but somehow more Political posts are made than people are interested in. I wonder how that happens.</p>
<div class="highlight"><pre><span></span><span class="c1"># Post count by flair</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select link_flair_text, (count*100.0/(select count(*) from submissions)) as percent from (select link_flair_text, count(*) as count from submissions group by link_flair_text)  order by percent desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Flair&#39;</span><span class="p">,</span> <span class="s1">&#39;Submission Percentage&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Flair</th>
<th>Submission Percentage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Non-Political</td>
<td>28.5036</td>
</tr>
<tr>
<td>Politics</td>
<td>23.8635</td>
</tr>
<tr>
<td>AskIndia</td>
<td>13.3852</td>
</tr>
<tr>
<td>Policy/Economy</td>
<td>6.13779</td>
</tr>
<tr>
<td>Demonetization</td>
<td>3.90912</td>
</tr>
<tr>
<td>Business/Finance</td>
<td>3.07831</td>
</tr>
<tr>
<td>[R]eddiquette</td>
<td>2.77312</td>
</tr>
<tr>
<td>Science/Technology</td>
<td>2.6469</td>
</tr>
<tr>
<td>Entertainment</td>
<td>2.39822</td>
</tr>
<tr>
<td>Policy &amp; Economy</td>
<td>1.91406</td>
</tr>
<tr>
<td>Sports</td>
<td>1.09079</td>
</tr>
<tr>
<td>Science &amp; Technology</td>
<td>1.07195</td>
</tr>
<tr>
<td>Policy</td>
<td>1.00224</td>
</tr>
<tr>
<td>Repost.</td>
<td>0.855297</td>
</tr>
<tr>
<td>Not about India.</td>
<td>0.817618</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><span class="c1"># Post score by flair</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select link_flair_text, score from (select link_flair_text, avg(score) as score, count(*) as count from submissions group by link_flair_text) where count &gt; 10 order by score desc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Flair&#39;</span><span class="p">,</span> <span class="s1">&#39;Submission Score&#39;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)))</span>
</pre></div>


<table>
<thead>
<tr>
<th>Flair</th>
<th>Submission Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>Misleading</td>
<td>167.048</td>
</tr>
<tr>
<td>Moderated</td>
<td>161.8</td>
</tr>
<tr>
<td>AMA</td>
<td>124.183</td>
</tr>
<tr>
<td>Unverified</td>
<td>112.259</td>
</tr>
<tr>
<td>Sports</td>
<td>91.9378</td>
</tr>
<tr>
<td>Casual AMA</td>
<td>80.9167</td>
</tr>
<tr>
<td>TIL Rule Violation.</td>
<td>76.617</td>
</tr>
<tr>
<td>[R]eddiquette</td>
<td>73.7887</td>
</tr>
<tr>
<td>Non-Political</td>
<td>66.3399</td>
</tr>
<tr>
<td>Entertainment</td>
<td>61.1406</td>
</tr>
<tr>
<td>Politics</td>
<td>59.652</td>
</tr>
<tr>
<td>Unverified Content.</td>
<td>59.6022</td>
</tr>
<tr>
<td>Science/Technology</td>
<td>57.1181</td>
</tr>
<tr>
<td>Meta.</td>
<td>56.6875</td>
</tr>
<tr>
<td>Policy/Economy</td>
<td>55.9699</td>
</tr>
</tbody>
</table>
<h2>Word Cloud of Submissions</h2>
<p>What data analysis is complete without great looking wordclouds? So here they are. I think the sizes of words should surprise no one. I was expecting a lot bigger "Modi" but I guess other non-important words took up too much of space.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">wordcloud</span> <span class="kn">import</span> <span class="n">WordCloud</span>
<span class="c1"># Submission title word cloud</span>
<span class="n">submission_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">b64text</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select title from submissions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64text</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">submission_title</span> <span class="o">+=</span> <span class="n">text</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
<span class="n">title_wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">submission_title</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">title_wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Wordcloud of Submission Titles&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>(-0.5, 1199.5, 599.5, -0.5)
</pre></div>


<p><img src="/images/reddit_da/wordcloud_submissions.png" width="80%"></p>
<div class="highlight"><pre><span></span><span class="c1"># Submission text word cloud</span>
<span class="n">submission_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">b64text</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select content from submissions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64text</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">submission_text</span> <span class="o">+=</span> <span class="n">text</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
<span class="n">text_wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">submission_text</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">text_wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Wordcloud of Submission Content&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>(-0.5, 1199.5, 599.5, -0.5)
</pre></div>


<p><img src="/images/reddit_da/wordcloud_submission_content.png" width="80%"></p>
<div class="highlight"><pre><span></span><span class="c1"># Comments text word cloud</span>
<span class="n">comment_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">b64text</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select content from comments where score &gt; 5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64text</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">comment_text</span> <span class="o">+=</span> <span class="n">text</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
<span class="n">comment_wordcloud</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">comment_text</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">comment_wordcloud</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Wordcloud of Comment Content&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>(-0.5, 1199.5, 599.5, -0.5)
</pre></div>


<p><img src="/images/reddit_da/wordcloud_comment_content.png" width="80%"></p>
<h2>Code and Extras</h2>
<p>Code for loading data into database is below.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">avro</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">praw</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">avro.datafile</span> <span class="kn">import</span> <span class="n">DataFileReader</span>
<span class="kn">from</span> <span class="nn">avro.io</span> <span class="kn">import</span> <span class="n">DatumReader</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>

<span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_int</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">RedditDataLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;reddit.db&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_author_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reddit</span><span class="p">,</span> <span class="n">author_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">reddit</span><span class="o">.</span><span class="n">redditor</span><span class="p">(</span><span class="n">author_name</span><span class="p">)</span>
            <span class="n">user_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">created_utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">author_name</span><span class="p">,</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">author_name</span><span class="p">,</span> <span class="n">user_since</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">link_karma</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">comment_karma</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Failed with exception&#39;</span><span class="p">,</span> <span class="n">e</span>
            <span class="k">return</span> <span class="n">author_name</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fetch_author_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reddit</span> <span class="o">=</span> <span class="n">praw</span><span class="o">.</span><span class="n">Reddit</span><span class="p">(</span><span class="n">client_id</span><span class="o">=</span><span class="s1">&#39;YOUR_REDDIT_CLIENT_ID&#39;</span><span class="p">,</span> <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">,</span> 
                <span class="n">username</span><span class="o">=</span><span class="s1">&#39;USERNAME&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;PASSWORD&#39;</span><span class="p">,</span> <span class="n">user_agent</span><span class="o">=</span><span class="s1">&#39;script&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">submission_authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select distinct(posted_by) from submissions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="n">comment_authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select distinct(posted_by) from comments&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="n">all_authors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">submission_authors</span> <span class="o">+</span> <span class="n">comment_authors</span><span class="p">)))</span>
        <span class="nb">print</span> <span class="s1">&#39;Found </span><span class="si">%d</span><span class="s1"> authors&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_authors</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">all_authors_data</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">author</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_author_info</span><span class="p">(</span><span class="n">reddit</span><span class="p">,</span> <span class="n">author</span><span class="p">),</span> <span class="n">all_authors</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Done fetching data&#39;</span>
        <span class="k">for</span> <span class="n">author_name</span><span class="p">,</span> <span class="n">author_details</span> <span class="ow">in</span> <span class="n">all_authors_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">author_details</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_author_details</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">author_name</span><span class="p">,</span> <span class="n">author_details</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission_file_name</span><span class="p">,</span> <span class="n">comment_file_name</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># read and load submissions</span>
        <span class="nb">print</span> <span class="s1">&#39;Reading and loading submissions data&#39;</span>
        <span class="n">submission_file</span> <span class="o">=</span> <span class="n">DataFileReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">submission_file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">DatumReader</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">submission</span> <span class="ow">in</span> <span class="n">submission_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_submission_details</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>

        <span class="c1"># read and load submissions</span>
        <span class="nb">print</span> <span class="s1">&#39;Reading and loading comments data&#39;</span>
        <span class="n">comment_file</span> <span class="o">=</span> <span class="n">DataFileReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">comment_file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">DatumReader</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comment_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_comment_details</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># If some tables exist, we don&#39;t need to create new ones</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM sqlite_master where type=&#39;table&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE users </span>
<span class="s1">                        (user_id text PRIMARY KEY, user_since timestamp, </span>
<span class="s1">                        link_karma real, comment_karma real)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE submissions</span>
<span class="s1">                        (submission_id text PRIMARY KEY, title text, content text,</span>
<span class="s1">                        link_flair_text text, posted_at timestamp, posted_by text, </span>
<span class="s1">                        upvotes int, downvotes int, score int, num_comments int)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE comments</span>
<span class="s1">                        (comment_id text PRIMARY KEY, submission_id text, parent_comment_id text,</span>
<span class="s1">                        content text, posted_at timestamp, posted_by text,</span>
<span class="s1">                        upvotes int, downvotes int, score int)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_submission_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">submission</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;created_utc&#39;</span><span class="p">]))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM submissions WHERE submission_id=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> 
                        <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;selftext&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;link_flair_text&#39;</span><span class="p">],</span>
                        <span class="n">created_at</span><span class="p">,</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;ups&#39;</span><span class="p">]),</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;downs&#39;</span><span class="p">]),</span> 
                        <span class="n">safe_int</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]),</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">submission</span><span class="p">[</span><span class="s1">&#39;num_comments&#39;</span><span class="p">]))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO submissions VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">submission</span><span class="p">,</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_add_comment_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="s1">&#39;created_utc&#39;</span><span class="p">]))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM comments WHERE comment_id=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">],</span>
                    <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span> 
                    <span class="n">created_at</span><span class="p">,</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="s1">&#39;ups&#39;</span><span class="p">]),</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="s1">&#39;downs&#39;</span><span class="p">]),</span> <span class="n">safe_int</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO comments VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_author_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">author_name</span><span class="p">,</span> <span class="n">author_details</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users WHERE user_id=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">author_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO users VALUES (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">author_details</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">e</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">data_loader</span> <span class="o">=</span> <span class="n">RedditDataLoader</span><span class="p">()</span>
    <span class="n">data_loader</span><span class="o">.</span><span class="n">create_tables</span><span class="p">()</span>
    <span class="n">data_loader</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="s1">&#39;data/submissions.avro&#39;</span><span class="p">,</span> <span class="s1">&#39;data/comments.avro&#39;</span><span class="p">)</span>
    <span class="n">data_loader</span><span class="o">.</span><span class="n">fetch_author_info</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;Done loading&#39;</span>
</pre></div>
      </div>
<!-- /.entry-content -->
      <footer class="post-info text-muted">
        <button type="button" class="btn btn-default">          
          <a href="/category/exploration.html"><div class="fa fa-lg fa-folder-open"></div> Exploration</a>
        </button>
      </footer>
      <!-- /.post-info -->
    </section>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text">&copy; <a href="">Hari Govardhanam</a> powered by <a href="http://getpelican.com/">pelican</a> and <a href="http://nodotcom.org">nikhil</a></p>
      </div>
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>